name: E2E Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: üß© Check out repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      # ------------------------------
      # INSTALL DEPENDENCIES
      # ------------------------------
      - name: üì¶ Install root dependencies
        run: npm install

      - name: üì¶ Install backend dependencies
        run: npm install
        working-directory: backend

      - name: üì¶ Install frontend dependencies
        run: npm install
        working-directory: Frontend

      # ------------------------------
      # BUILD FRONTEND
      # ------------------------------
      - name: üñåÔ∏è Build Frontend
        working-directory: Frontend
        run: npm run build

      # ------------------------------
      # INSTALL PLAYWRIGHT
      # ------------------------------
      - name: üé≠ Install Playwright browsers
        working-directory: e2e
        run: npx playwright install --with-deps

      # ------------------------------
      # RUN TESTS
      # ------------------------------
      - name: üß™ Run Playwright E2E Tests
        env:
          CI: true
          NODE_ENV: test
          E2E_MODE: "true"     # ‚òÖ Critical
          API_BASE_URL: "http://localhost:3001"

          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}

          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }} # still passed but NOT used
        run: npx playwright test --config=e2e/playwright.config.js

      # ------------------------------
      # UPLOAD REPORT
      # ------------------------------
      - name: üìä Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7
